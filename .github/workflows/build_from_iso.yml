name: Build Vagrant Boxes (from ISO)

on:
  # Allows this workflow to be run manually from the "Actions" tab
  workflow_dispatch:
    inputs:
      # A dropdown menu to select the box directory
      distro:
        description: 'Which box to build?'
        required: true
        type: choice
        options:
          - ubuntu-24.04
          - alpine-3.20
          - rocky-9
          - debian-13
  
      iso_version:
        description: 'ISO version (optional, e.g. 24.04.3). If empty, latest will be used'
        required: false
        default: ""
          
      architecture:
        description: 'Which architecture?'
        required: true
        type: choice
        options:
          - amd64
          - arm64

      # A menu to select the provider. These names MUST match
      # the start of the 'name' of your 'source' blocks in Packer.
      provider:
        description: 'Which provider?'
        required: true
        type: choice
        options:
          - virtualbox-iso
          - vmware-iso
          - qemu
          - all

jobs:
  build:
    name: Build (${{ matrix.provider }} on ${{ inputs.distro }} [${{ matrix.architecture }}])
    # GitHub runner
    runs-on: "${{ matrix.architecture == 'arm64' && 'macos-15' || 'ubuntu-24.04' }}"

    strategy:
      # Don't cancel other builds if one fails (e.g., if VBox fails, let QEMU continue)
      fail-fast: false
      # Create parallel jobs based on your 'provider' choice
      matrix:
        provider: ${{ fromJSON(inputs.provider == 'all' && '["virtualbox-iso", "vmware-iso", "qemu"]' || format('["{0}"]', inputs.provider)) }}
        architecture: ${{ fromJSON(format('["{0}"]', inputs.architecture)) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Checks
        run: |
          lscpu | grep Virtualization
          VCORES=$(egrep -c '(vmx|svm)' /proc/cpuinfo)
          echo "VCORES=$VCORES"
          if [ "$VCORES" -lt 1 ]; then
            echo "Nested virtualization not found!"
          fi
          uname -a
          df -h

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: latest

      - name: Install Dependencies (QEMU)
        if: matrix.provider == 'qemu'
        run: |
          # Linux (amd64) requires hypervisor packages
          # macOS (arm64) use preinstalled QEMU 
          if [ "$RUNNER_OS" == "macOS" ]; then
            echo "Installing QEMU packages on macOS..."
            brew install qemu
          elif [ "$RUNNER_OS" == "Linux" ]; then
            echo "Installing QEMU/Libvirt packages on Linux..."
            sudo apt-get update
            sudo apt-get install -y qemu-kvm libvirt-daemon-system libvirt-clients virtinst bridge-utils qemu-utils libvirt-dev
            echo "Enabling KVM..."
            echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
            sudo udevadm control --reload-rules
            sudo udevadm trigger --name-match=kvm
            sudo usermod -aG kvm $USER
            sudo usermod -aG libvirt $USER
            sudo chmod o+rw /var/run/libvirt/libvirt-sock
            sudo systemctl start libvirtd
            sudo systemctl status libvirtd
          else
            echo "Error: unexpected RUNNER_OS: $RUNNER_OS"
            exit 1
          fi
          echo "QEMU dependencies installed."

      - name: Install Dependencies (VirtualBox)
        if: matrix.provider == 'virtualbox-iso'
        run: |
          if [ "$RUNNER_OS" == "macOS" ]; then
            echo "Installing VirtualBox on macOS (arm64)..."
            curl -L -o virtualbox.dmg "https://download.virtualbox.org/virtualbox/7.2.4/VirtualBox-7.2.4-170995-macOSArm64.dmg"
            hdiutil attach virtualbox.dmg
            sudo installer -pkg /Volumes/VirtualBox/VirtualBox.pkg -target /
            hdiutil detach /Volumes/VirtualBox
          elif [ "$RUNNER_OS" == "Linux" ]; then
            echo "Installing VirtualBox on Linux (amd64)..."
            curl -fsSL https://www.virtualbox.org/download/oracle_vbox_2016.asc | sudo gpg --dearmor -o /usr/share/keyrings/oracle-virtualbox-2016.gpg
            echo "deb [arch=amd64 signed-by=/usr/share/keyrings/oracle-virtualbox-2016.gpg] https://download.virtualbox.org/virtualbox/debian $(lsb_release -cs) contrib" | sudo tee /etc/apt/sources.list.d/virtualbox.list
            sudo apt-get update
            sudo apt-get install -y virtualbox-7.2
          else
            echo "Error: unexpected RUNNER_OS: $RUNNER_OS"
            exit 1
          fi
          echo "VirtualBox installed."
          vboxmanage --version

      - name: Install Dependencies (VMware)
        if: matrix.provider == 'vmware-iso'
        env:
          VMWARE_URL_ARM: ${{ secrets.VMWARE_FUSION_URL }}
          VMWARE_URL_AMD: ${{ secrets.VMWARE_WORKSTATION_URL }}
        run: |
          if [ "$RUNNER_OS" == "macOS" ]; then
            if [ -z "$VMWARE_URL_ARM" ]; then echo "Error: VMWARE_FUSION_URL secret is not set."; exit 1; fi
            echo "Downloading VMware Fusion (arm64)..."
            curl -L -o VMware-Fusion.dmg "$VMWARE_URL_ARM"
            echo "Installing VMware..."
            hdiutil attach VMware-Fusion.dmg
            sudo "/Volumes/VMware Fusion/Install VMware Fusion.app/Contents/MacOS/applet" -silent -EULAS_AGREED=1
            hdiutil detach "/Volumes/VMware Fusion"
          elif [ "$RUNNER_OS" == "Linux" ]; then
            if [ -z "$VMWARE_URL_AMD" ]; then echo "Error: VMWARE_WORKSTATION_URL secret is not set."; exit 1; fi
            echo "Downloading VMware Workstation (amd64)..."
            curl -L -o vmware.bundle "$VMWARE_URL_AMD"
            chmod +x vmware.bundle
            echo "Installing VMware..."
            sudo ./vmware.bundle --console --required --eulas-agreed
          else
            echo "Error: unexpected RUNNER_OS: $RUNNER_OS"
            exit 1
          fi
          echo "VMware installed."
          vmware --version

      # --- BUILD STEP ---
      - name: Validate and Build with Packer
        run: |
          set -euo pipefail
          sudo mkdir -p /mnt/repo
          sudo chmod -R 777 /mnt/repo
          REPO="${{ github.workspace }}"
          cp -r $REPO/* /mnt/repo
          REPO_HOME=/mnt/repo
          PACKER_TEMPLATE=$REPO_HOME/template.pkr.hcl
          cd $REPO_HOME
          
          DISTRO="${{ inputs.distro }}"
          OS_NAME="$(echo "$DISTRO" | cut -d- -f1)"
          VERSION_DIR="$(echo "$DISTRO" | cut -d- -f2)"
          ISO_DIR=$REPO_HOME/os_configs/${OS_NAME}/${VERSION_DIR}/iso
          echo "Using ISO_DIR=${ISO_DIR}"
          
          if [ ! -d "$ISO_DIR" ]; then
            echo "Error: expected iso directory not found: $ISO_DIR"
            ls -la "$(dirname "$ISO_DIR")" || true
            exit 1
          fi

          cd "${ISO_DIR}"
          
          if [ -z "${{ inputs.iso_version }}" ]; then
            echo "No iso_version provided, selecting latest..."
            VERSION_PKR=$(ls versions/*.pkrvars.hcl 2>/dev/null | sort | tail -n1 || true)
          else
            VERSION_PKR="versions/${{ inputs.iso_version }}.pkrvars.hcl"
          fi
          
          if [ ! -f "$VERSION_PKR" ]; then
            echo "Error: version file not found: $VERSION_PKR"
            ls -la versions || true
            exit 1
          fi

          # Ensure common exists
          if [ ! -f "common.pkrvars.hcl" ]; then
            echo "Error: common.pkrvars.hcl not found in ${ISO_DIR}"
            ls -la || true
            exit 1
          fi
          
          echo "Initializing Packer template..."
          packer init $PACKER_TEMPLATE

          echo "Validating Packer template..."
          packer validate -var="build_arch=${{ inputs.architecture }}" -var-file="common.pkrvars.hcl" -var-file="$VERSION_PKR" $PACKER_TEMPLATE

          echo "Building box for: ${{ matrix.provider }} on ${{ inputs.architecture }}"
          export PACKER_LOG=1
          packer build -var="build_arch=${{ inputs.architecture }}" -var-file="common.pkrvars.hcl" -var-file="$VERSION_PKR" -only="${{ matrix.provider }}.${{ matrix.architecture }}" $PACKER_TEMPLATE

      - name: Post-mortem debug (VirtualBox only)
        if: failure()
        run: |
          echo "--- Build failed. Running post-mortem debug ---"
          if [ "${{ matrix.provider }}" != "virtualbox-iso" ]; then
            echo "VirtualBox provider not used"
            exit 1
          fi
          
          echo "Listing VirtualBox VMs:"
          vboxmanage list vms
          
          echo "Listing Host-Only Interfaces:"
          vboxmanage list hostonlyifs
          
          echo "Listing Runner IP Addresses:"
          ip a

          echo "Attempting to find VM log..."
          VM_NAME=$(vboxmanage list runningvms | awk -F'"' '{print $2}' | head -n 1)
          
          if [ -z "$VM_NAME" ]; then
            VM_NAME=$(vboxmanage list vms | awk -F'"' '{print $2}' | head -n 1)
          fi

          if [ -n "$VM_NAME" ]; then
            echo "Found VM: $VM_NAME"
            echo "--- Dumping VM Info ---"
            vboxmanage showvminfo "$VM_NAME"
            
            echo "--- Dumping VM Log (VBox.log) ---"
            LOG_PATH=$(vboxmanage showvminfo "$VM_NAME" --machinereadable | grep "LogFile=" | awk -F'"' '{print $2}')
            
            if [ -f "$LOG_PATH" ]; then
              cat "$LOG_PATH"
            else
              echo "VM Log file not found at: $LOG_PATH"
            fi
          else
            echo "Could not determine VM name. No logs to dump."
          fi
          echo "--- End of post-mortem debug ---"
      
      # --- ARTIFACT UPLOAD STEP ---
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.distro }}-${{ inputs.architecture }}--${{ inputs.iso_version }}_${{ matrix.provider }}.box
          path: ./${{ inputs.distro }}-*.box
          if-no-files-found: error
          retention-days: 14 # Keep artifact for 14 days (default is 90)
 
      - name: Upload packer log (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: packer-log-iso-${{ github.run_number }}
          path: packer-iso.log
